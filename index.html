<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dragon Ball RP Hub — Updated</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- keep your theme 1:1 (colors, radii, etc) --- */
        :root{
          --bg-deep:#07060a; --bg-mid:#0f1320; --card:#11121a; --muted:#bfc6d0;
          --accent-orange:#ff8a00; --accent-yellow:#ffd24d; --accent-blue:#00b7ff;
          --saiyan-red:#ff3131; --namekian-green:#2fb44f; --frieza-purple:#b270ff;
          --android-green:#8eff8a; --majin-pink:#ff77ff; --kai-pink:#ff88ff;
          --glass:rgba(255,255,255,0.04); --glass-border:rgba(255,255,255,0.04);
          --radius:12px; --soft-shadow:0 8px 30px rgba(2,6,23,0.6); --transition:180ms cubic-bezier(.2,.9,.3,1);
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Orbitron, sans-serif;background:var(--bg-deep);color:var(--muted);min-height:100vh;padding:20px;
          background-image:
            radial-gradient(1200px 600px at 10% 10%, rgba(255,138,0,0.06), transparent 10%),
            radial-gradient(900px 500px at 90% 80%, rgba(0,183,255,0.04), transparent 12%),
            linear-gradient(180deg,var(--bg-mid) 0%, var(--bg-deep) 60%);
          overflow-x:hidden;
        }
        #app{max-width:1400px;margin:0 auto}
        header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;margin-bottom:30px;border-bottom:1px solid var(--glass-border)}
        .logo{display:flex;align-items:center;gap:15px}
        .logo-pill{background:linear-gradient(90deg,var(--accent-orange),var(--accent-yellow));color:#111;padding:8px 12px;border-radius:999px;font-weight:700}
        .admin-badge{background:linear-gradient(90deg,var(--accent-blue),#0066ff);color:white;padding:4px 10px;border-radius:999px;font-size:0.8rem;margin-left:10px;display:none}
        nav{display:flex;gap:10px;flex-wrap:wrap}
        .nav-btn{padding:10px 16px;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:500}
        .nav-btn:hover,.nav-btn.active{background:linear-gradient(90deg, rgba(255,138,0,0.2), rgba(0,183,255,0.1));color:var(--accent-yellow);box-shadow:0 0 15px rgba(255,138,0,0.1);border-color:rgba(255,138,0,0.3)}
        .page{display:none;animation:fadeIn 0.5s ease;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:var(--radius);padding:20px;box-shadow:var(--soft-shadow);border:1px solid var(--glass-border);margin-bottom:30px}
        .page.active{display:block}
        .page-header{margin-bottom:25px;text-align:center;padding-bottom:15px;border-bottom:1px solid var(--glass-border)}
        .page-title{font-size:28px;font-weight:700;margin-bottom:10px;color:var(--accent-yellow)}
        .page-subtitle{color:var(--muted);font-size:16px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--soft-shadow);border:1px solid var(--glass-border);text-align:center}
        .stat-icon{font-size:32px;margin-bottom:12px;color:var(--accent-orange)}
        .stat-value{font-size:28px;font-weight:700;margin-bottom:5px;color:var(--accent-yellow)}
        .stat-label{color:var(--muted);font-size:14px}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
        .card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--soft-shadow);border:1px solid var(--glass-border)}
        .card-header{padding:15px 20px;background:linear-gradient(90deg, rgba(255,138,0,0.1), rgba(0,183,255,0.05));color:var(--accent-orange);font-weight:700}
        .card-body{padding:20px}
        .form-input,.form-select,.form-textarea,.oc-input,.oc-select,.oc-textarea{width:100%;padding:10px 12px;background:transparent;border:1px solid var(--glass-border);border-radius:var(--radius);color:var(--muted);font-family:inherit}
        .form-textarea{min-height:100px}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);color:var(--muted);cursor:pointer}
        .btn-primary{background:linear-gradient(90deg,var(--accent-orange),var(--accent-yellow));color:#111;border:none;font-weight:700}
        .btn-success{background:linear-gradient(90deg,#00cc7a,#00b36b);color:white;border:none}
        .btn-danger{background:linear-gradient(90deg,var(--saiyan-red),#cc0000);color:white;border:none}
        .btn-sm{padding:6px 12px;font-size:0.8rem}
        .table-container{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--soft-shadow);border:1px solid var(--glass-border);margin-bottom:25px;overflow-x:auto}
        table{width:100%;border-collapse:collapse}
        th,td{padding:12px 15px;text-align:left;border-bottom:1px solid var(--glass-border);font-size:0.9rem}
        th{background:rgba(0,0,0,0.2);font-weight:600;color:var(--accent-blue)}
        tr:hover{background:rgba(255,255,255,0.03)}
        .sheet-header{display:flex;gap:12px;align-items:center;margin-bottom:15px}
        .sheet-title{margin:0;font-size:1.2rem;color:var(--accent-yellow)}
        .section{margin-bottom:15px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
        .section-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 12px;background:linear-gradient(90deg, rgba(255,138,0,0.06), rgba(0,183,255,0.03));cursor:pointer}
        .section-head h2{margin:0;font-size:0.98rem;color:var(--accent-orange)}
        .section-body{padding:12px;border-top:1px solid rgba(255,255,255,0.02);transition:max-height var(--transition),opacity var(--transition);overflow:hidden}
        .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .oc-sheet-container{display:grid;grid-template-columns:1fr 360px;gap:24px;align-items:start}
        .oc-content{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:var(--radius);padding:18px;box-shadow:var(--soft-shadow);border:1px solid var(--glass-border)}
        .oc-infopanel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;box-shadow:0 18px 40px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);position:sticky;top:24px;height:fit-content;outline:2px solid rgba(0,183,255,0.03)}
        .oc-section{margin-bottom:14px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
        .oc-section .section-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 12px;background:linear-gradient(90deg, rgba(255,138,0,0.06), rgba(0,183,255,0.03));cursor:pointer}
        .oc-section .section-body{padding:12px;border-top:1px solid rgba(255,255,255,0.02);transition:max-height var(--transition),opacity var(--transition);overflow:hidden}
        .oc-section.collapsed .section-body{max-height:0;opacity:0;padding-top:0;padding-bottom:0}
        .oc-section.expanded .section-body{max-height:1200px;opacity:1}
        .label{font-size:0.78rem;color:var(--accent-blue);margin-bottom:6px;display:block}
        .dynamic-list{margin-top:8px}
        .entry{background:linear-gradient(180deg, rgba(255,255,255,0.012), transparent);border:1px solid rgba(0,183,255,0.06);border-radius:10px;padding:8px;margin-bottom:10px;display:flex;gap:10px;align-items:flex-start}
        .entry-number{font-weight:700;color:var(--accent-yellow);width:36px;text-align:center;flex-shrink:0;margin-top:6px;font-size:0.95rem}
        .entry-img-wrap{width:84px;height:84px;border-radius:8px;overflow:hidden;border:2px solid rgba(255,138,0,0.14);box-shadow:0 6px 18px rgba(255,138,0,0.04) inset;flex-shrink:0;cursor:pointer;background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center}
        .entry-content{flex:1;display:flex;flex-direction:column;gap:6px}
        .entry-content input[type="text"], .entry-content textarea {background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px;border-radius:6px;font-size:0.9rem}
        .entry .remove-btn{background:none;border:none;color:var(--saiyan-red);font-size:1.1rem;cursor:pointer;align-self:center;padding:6px 8px}
        .oc-image-viewer{width:100%;height:200px;border-radius:var(--radius);overflow:hidden;margin-bottom:15px;border:2px solid var(--glass-border);display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.2);cursor:pointer}
        .oc-image-viewer img{max-width:100%;max-height:100%;object-fit:contain}
        .oc-image-placeholder{color:var(--muted);text-align:center;padding:20px}
        .badge{display:inline-block;padding:4px 8px;border-radius:20px;font-size:0.8rem;font-weight:700}
        .badge-primary{background:var(--accent-orange);color:#111}.badge-success{background:#00cc7a;color:white}.badge-warning{background:var(--accent-yellow);color:#111}.badge-danger{background:var(--saiyan-red);color:white}
        .admin-only{display:none}
        .admin-mode .admin-only{display:block}
        .admin-mode .editable{border:1px dashed rgba(255,138,0,0.5);padding:5px;border-radius:4px;cursor:text}
        .portrait-container{position:relative;width:96px;height:96px;margin-top:10px}
        .portrait-image{width:100%;height:100%;object-fit:cover;border-radius:8px;border:3px solid rgba(255,165,0,0.9)}
        .portrait-aura{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:8px;opacity:0.5;mix-blend-mode:overlay;animation:auraGlow 2s infinite alternate}
        .portrait-info{margin-top:8px;text-align:center}
        .portrait-name{font-weight:bold;color:var(--accent-yellow);font-size:0.9rem}
        .portrait-range{font-size:0.75rem;color:var(--muted)}
        .race-saiyan{color:var(--saiyan-red)}.race-namekian{color:var(--namekian-green)}.race-frieza{color:var(--frieza-purple)}.race-android{color:var(--android-green)}.race-majin{color:var(--majin-pink)}.race-kai{color:var(--kai-pink)}.race-human{color:var(--accent-blue)}.race-other{color:var(--muted)}
        /* small helpers */
        .text-center{text-align:center}.mt-20{margin-top:20px}.mb-20{margin-bottom:20px}.d-flex{display:flex}.align-center{align-items:center}.justify-between{justify-content:space-between}.gap-10{gap:10px}.gap-20{gap:20px}
        /* ensure entry inputs are readable (fix white-on-white issue) */
        .entry input, .entry textarea, .entry select { color:var(--muted) !important; background:transparent !important; border:1px solid rgba(255,255,255,0.03) !important; }
        /* modals (simple) */
        .modal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:9999}
        .modal .modal-content{background:var(--card);border-radius:10px;padding:0;min-width:320px;max-width:880px;border:1px solid var(--glass-border);overflow:hidden}
        .modal .modal-header{padding:12px 16px;background:linear-gradient(90deg, rgba(255,138,0,0.06), rgba(0,183,255,0.03));display:flex;align-items:center;justify-content:space-between}
        .modal .modal-body{padding:16px}
        .modal .modal-close{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--muted)}
        @media(max-width:992px){.stats-grid{grid-template-columns:repeat(2,1fr)}.cards-grid{grid-template-columns:repeat(2,1fr)}.timeline::before{left:30px}.timeline-item{width:100%;padding-left:70px;padding-right:20px}.timeline-item:nth-child(even){left:0}.timeline-content::before{left:-30px!important;background:linear-gradient(to left,var(--accent-orange),transparent)!important}.oc-sheet-container{grid-template-columns:1fr}.oc-infopanel{position:relative;top:auto}}
        @media(max-width:768px){header{flex-direction:column;gap:15px}nav{flex-wrap:wrap;justify-content:center}.stats-grid{grid-template-columns:1fr}.cards-grid{grid-template-columns:1fr}.two-col{grid-template-columns:1fr}.relation-form{grid-template-columns:1fr}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes auraGlow { from { box-shadow: 0 0 10px currentColor; } to { box-shadow: 0 0 25px currentColor; } }
        /* Worldview CSS from document1 (restored) */
        .planet-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 25px; }
        .planet { width: 140px; text-align: center; cursor: pointer; }
        .planet img { width: 140px; height: 140px; border-radius: 50%; border: 3px solid rgba(255,165,0,0.9); box-shadow: 0 0 20px rgba(255,165,0,0.12); display: block; margin: 0 auto 6px; object-fit: cover; transition: transform 220ms ease, box-shadow 220ms ease; }
        .planet:hover img { transform: scale(1.06); box-shadow: 0 0 42px rgba(0,183,255,0.14); }
    </style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">
      <div class="logo-pill">DRAGON BALL RP HUB</div>
      <div id="adminBadge" class="admin-badge">ADMIN MODE</div>
    </div>
    <nav>
      <button class="nav-btn active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</button>
      <button class="nav-btn" data-page="oc-sheet"><i class="fas fa-file-alt"></i> OC Sheet</button>
      <button class="nav-btn" data-page="worldview"><i class="fas fa-globe"></i> Worldview</button>
      <button class="nav-btn" data-page="timeline"><i class="fas fa-history"></i> Timeline</button>
      <button class="nav-btn" data-page="relationships"><i class="fas fa-code-branch"></i> Relationships</button>
      <button id="manageOcsBtn" class="nav-btn admin-only" data-page="manage"><i class="fas fa-users-cog"></i> Manage OCs</button>
      <button id="adminLoginBtn" class="nav-btn"><i class="fas fa-lock"></i> Admin Login</button>
    </nav>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="page active">
      <div class="page-header">
        <h1 class="page-title">Server Dashboard</h1>
        <p class="page-subtitle">Welcome to your Dragon Ball RP server management hub</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div>
          <div id="totalOCs" class="stat-value">0</div><div class="stat-label">Total OCs</div></div>

        <div class="stat-card"><div class="stat-icon"><i class="fas fa-user-check"></i></div>
          <div id="approvedOCs" class="stat-value">0</div><div class="stat-label">Approved OCs</div></div>

        <div class="stat-card admin-only"><div class="stat-icon"><i class="fas fa-user-clock"></i></div>
          <div id="pendingOCs" class="stat-value">0</div><div class="stat-label">Pending Approval</div></div>

        <div class="stat-card"><div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
          <div id="currentArcs" class="stat-value">0</div><div class="stat-label">Current Arcs</div></div>
      </div>

      <div class="cards-grid">
        <div class="card admin-only">
          <div class="card-header"><i class="fas fa-tasks"></i> Pending Approvals</div>
          <div class="card-body"><p id="pendingSummary">You have 0 OCs waiting for your approval.</p><button class="btn btn-primary mt-20" onclick="showPage('manage')"><i class="fas fa-clipboard-check"></i> Review OCs</button></div>
        </div>

        <div class="card">
          <div class="card-header"><i class="fas fa-chart-line"></i> Server Activity</div>
          <div class="card-body"><p>View server statistics and activity reports.</p><button class="btn btn-primary mt-20" onclick="openReports()"><i class="fas fa-chart-bar"></i> View Reports</button></div>
        </div>
      </div>

      <div class="table-container mt-20">
        <table>
          <thead><tr><th>Name</th><th>Race</th><th>Power Level</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="dashboardOcTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- OC SHEET -->
    <section id="oc-sheet" class="page">
      <div class="page-header">
        <h1 class="page-title">OC Character Sheet</h1>
        <p class="page-subtitle">Create and manage your Original Character</p>
      </div>

      <div class="oc-sheet-container">
        <section class="oc-content" aria-labelledby="sheetTitle">
          <div class="sheet-header">
            <div class="logo-pill">DRAGON BALL — OC SHEET</div>
            <div id="sheetTitle" class="sheet-title editable" contenteditable="true" tabindex="0" role="textbox" aria-label="Character tagline" data-placeholder="Character Quote / Tagline — (click to edit)">Character Quote / Tagline — (click to edit)</div>
          </div>

          <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
            <button class="btn" onclick="toggleAllSections(true)"><i class="fas fa-expand"></i> Expand All</button>
            <button class="btn" onclick="toggleAllSections(false)"><i class="fas fa-compress"></i> Collapse All</button>
            <button class="btn btn-primary" onclick="downloadJSON()"><i class="fas fa-download"></i> Export JSON</button>
            <button class="btn" onclick="saveOCFromSheet()"><i class="fas fa-save"></i> Save OC</button>
            <button id="clearBtn" class="btn" onclick="clearAll()" title="Clear all sheet fields"><i class="fas fa-trash"></i> Clear All</button>
          </div>

          <!-- Backstory -->
          <article class="oc-section expanded" id="sec-backstory">
            <div class="section-head" onclick="toggleSection(this)"><h2>Backstory</h2><div class="meta">▼</div></div>
            <div class="section-body">
              <div class="field"><label class="label">Short summary</label><textarea id="backstory_short" class="oc-textarea" placeholder="Short summary or hook..."></textarea></div>
              <div class="field"><label class="label">Full backstory</label><textarea id="backstory_full" class="oc-textarea" placeholder="Detailed backstory..."></textarea></div>
            </div>
          </article>

          <!-- Personality -->
          <article class="oc-section expanded" id="sec-personality">
            <div class="section-head" onclick="toggleSection(this)"><h2>Personality</h2><div class="meta">▼</div></div>
            <div class="section-body">
              <div class="two-col">
                <div>
                  <div class="field"><label class="label">Traits</label><textarea id="traits" class="oc-textarea" placeholder="Key personality traits..."></textarea></div>
                  <div class="field"><label class="label">Likes</label><textarea id="likes" class="oc-textarea" placeholder="Favorites, foods, hobbies..."></textarea></div>
                </div>
                <div>
                  <div class="field"><label class="label">Fears/Weaknesses</label><textarea id="fears" class="oc-textarea" placeholder="Fears, psychological weaknesses..."></textarea></div>
                  <div class="field"><label class="label">Goals / Dreams</label><textarea id="goals" class="oc-textarea" placeholder="Long term goals..."></textarea></div>
                </div>
              </div>
            </div>
          </article>

          <!-- Abilities & Techniques -->
          <article class="oc-section expanded" id="sec-abilities">
            <div class="section-head" onclick="toggleSection(this)"><h2>Abilities & Techniques</h2><div class="meta">▼</div></div>
            <div class="section-body">
              <div class="field">
                <label class="label">Signature Abilities</label>
                <div id="abilitiesList" class="dynamic-list"></div>
                <div style="margin-top:8px"><button class="btn" onclick="addEntry('abilitiesList')">+ Add Ability</button></div>
              </div>
              <div class="field" style="margin-top:8px">
                <label class="label">Techniques</label>
                <div id="techniquesList" class="dynamic-list"></div>
                <div style="margin-top:8px"><button class="btn" onclick="addEntry('techniquesList')">+ Add Technique</button></div>
              </div>
            </div>
          </article>

          <!-- Transformations -->
          <article class="oc-section expanded" id="sec-transforms">
            <div class="section-head" onclick="toggleSection(this)"><h2>Transformations</h2><div class="meta">▼</div></div>
            <div class="section-body">
              <div id="transformsList" class="dynamic-list"></div>
              <div style="margin-top:8px"><button class="btn" onclick="addEntry('transformsList','transform')">+ Add Transformation</button></div>
            </div>
          </article>

          <!-- Equipment -->
          <article class="oc-section expanded" id="sec-equipment">
            <div class="section-head" onclick="toggleSection(this)"><h2>Equipment</h2><div class="meta">▼</div></div>
            <div class="section-body">
              <div id="equipmentList" class="dynamic-list"></div>
              <div style="margin-top:8px"><button class="btn" onclick="addEntry('equipmentList')">+ Add Equipment</button></div>
            </div>
          </article>

          <!-- Notable Battles -->
          <article class="oc-section expanded" id="sec-battles">
            <div class="section-head" onclick="toggleSection(this)"><h2>Notable Battles / Events</h2><div class="meta">▼</div></div>
            <div class="section-body">
              <div class="field"><label class="label">Battles</label><textarea id="battles" class="oc-textarea" placeholder="Descriptions and outcomes..."></textarea></div>
            </div>
          </article>
        </section>

        <!-- RIGHT INFO PANEL -->
        <aside class="oc-infopanel" aria-labelledby="infoTitle" id="infoPanel">
          <div class="info-header">
            <div style="display:flex;gap:8px;align-items:center;">
              <div style="flex:1">
                <div style="display:flex;gap:8px;align-items:center">
                  <div style="flex:1">
                    <div style="display:flex;gap:8px;align-items:center">
                      <div style="flex:1"><input id="ocName" type="text" class="oc-input" placeholder="OC Name" style="font-size:1.06rem;font-weight:700" /></div>
                      <button class="btn" onclick="fillExample()" title="Fill example">Example</button>
                    </div>
                    <div style="margin-top:8px"><input id="ocAlias" type="text" class="oc-input" placeholder="Alias / Title (optional)" /></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- OC Image Display / multi-image uploader -->
          <div style="margin-bottom:10px">
            <label class="label">Portraits / Images (multiple)</label>
            <div id="ocImageViewer" class="oc-image-viewer" onclick="document.getElementById('posterFiles').click()">
              <div id="imageCarouselWrap" style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px;">
                <button class="btn btn-sm" onclick="prevImage(event)" title="Previous">‹</button>
                <div id="ocImageDisplay" style="flex:1;min-height:160px;display:flex;align-items:center;justify-content:center"></div>
                <button class="btn btn-sm" onclick="nextImage(event)" title="Next">›</button>
              </div>
            </div>
            <input id="posterFiles" type="file" accept="image/*" multiple style="margin-top:8px" />
            <div id="imageCount" style="font-size:0.85rem;color:var(--muted);margin-top:6px"></div>
          </div>

          <div class="scouter" title="Power level" style="margin-bottom:8px">
            <div class="field"><div class="label">Creator (name or Discord tag)</div><input id="creatorInput" class="oc-input" placeholder="@DiscordName#0000 or YourName" /></div>
            <div style="margin-top:6px"><div class="label">Power Level</div>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="powerInput" class="oc-input" type="number" placeholder="e.g. 9000" />
                <button class="btn" onclick="readPower()" title="Scan">Scan</button>
              </div>
            </div>
            <div style="text-align:right;margin-top:8px">
              <div class="pl" id="plValue">—</div>
              <div class="cat" id="plCategory">—</div>
            </div>

            <!-- PL portrait + aura -->
            <div class="portrait-container" id="plPortraitWrap">
                <img id="plPortraitImg" class="portrait-image" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij48cmVjdCB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIGZpbGw9IiMwZTBlMTUiIHJ4PSI4Ii8+PHRleHQgeD0iNDgiIHk9IjUwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPlBvd2VyIExldmVsIFBvcnRyYWl0PC90ZXh0Pjwvc3ZnPg==" alt="PL Portrait" />
                <div class="portrait-aura" id="plPortraitAura" style="background-color:transparent"></div>
            </div>
            <div class="portrait-info">
                <div id="plPortraitName" class="portrait-name">—</div>
                <div id="plPortraitRange" class="portrait-range">—</div>
            </div>
          </div>

          <div class="infobox" aria-hidden="false" style="margin-top:12px">
            <div class="field"><label class="label">Race</label>
              <select id="raceSelect" class="oc-select">
                <option value="">Select...</option>
                <option>Saiyan</option><option>Namekian</option><option>Frieza Race</option><option>Human</option><option>Android</option><option>Majin</option><option>Kai</option><option>Other</option>
              </select>
            </div>
            <div class="field"><label class="label">Universe</label><input id="universe" class="oc-input" placeholder="Universe 7"/></div>
            <div class="field"><label class="label">Home Planet</label><input id="homeplanet" class="oc-input" placeholder="e.g. Planet Vegeta"/></div>
            <div class="field"><label class="label">Age</label><input id="age" class="oc-input"/></div>
            <div class="field"><label class="label">Height</label><input id="height" class="oc-input" placeholder="cm / ft"/></div>
            <div class="field"><label class="label">Weight</label><input id="weight" class="oc-input" placeholder="kg / lb"/></div>
            <div class="field"><label class="label">Eye Color</label><input id="eyecolor" class="oc-input"/></div>
            <div class="field"><label class="label">Hair Color</label><input id="haircolor" class="oc-input"/></div>
            <div class="field"><label class="label">Blood Type</label><input id="blood" class="oc-input"/></div>
            <div class="field"><label class="label">Occupations / Affiliations</label><input id="affils" class="oc-input" placeholder="Z-Fighters, Frieza Force"/></div>
          </div>
        </aside>
      </div>
    </section>

    <!-- WORLDVIEW (restored from document 1) -->
    <section id="worldview" class="page">
      <div class="page-header">
        <h1 class="page-title">Worldview</h1>
        <p class="page-subtitle">Explore the planets and OCs in your Dragon Ball universe</p>
      </div>

      <div class="planet-grid">
        <div class="planet"><img src="https://static.wikia.nocookie.net/dragonball/images/3/36/Planet_Sadala.png/revision/latest/scale-to-width-down/300?cb=20181125012120" alt="Sadala"><div>Sadala</div></div>
        <div class="planet"><img src="https://static.wikia.nocookie.net/dragonball/images/0/0c/Yardrat.png/revision/latest/scale-to-width-down/300?cb=20181125012120" alt="Yardrat"><div>Yardrat</div></div>
        <div class="planet"><img src="https://static.wikia.nocookie.net/dragonball/images/6/6a/King_Kai%27s_Planet.png/revision/latest/scale-to-width-down/300?cb=20181125012120" alt="King Kai's Planet"><div>King Kai's Planet</div></div>
        <div class="planet"><img src="https://static.wikia.nocookie.net/dragonball/images/9/9e/New_Namek.png/revision/latest/scale-to-width-down/300?cb=20181125012120" alt="New Namek"><div>New Namek</div></div>
        <!-- ADDED: Planet Namek (original) -->
        <div class="planet"><img src="https://dragonball.fandom.com/wiki/Namek?action=render&image=Namek.png" alt="Planet Namek"><div>Planet Namek</div></div>
        <div class="planet"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><defs><radialGradient id='g' cx='30%' cy='30%'><stop offset='0' stop-color='%234aa3ff'/><stop offset='1' stop-color='%230b3a6b'/></radialGradient></defs><rect width='100%' height='100%' rx='999' fill='%23051021'/><circle cx='60' cy='60' r='50' fill='url(%23g)' stroke='%23d4f0ff' stroke-opacity='0.06' stroke-width='2'/></svg>' alt="Earth"><div>Earth</div></div>
        <div class="planet"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' rx='999' fill='%2308020a'/><circle cx='60' cy='60' r='50' fill='%236b0000' stroke='%23ffb075' stroke-opacity='0.08' stroke-width='2'/></svg>" alt="Planet Vegeta"><div>Planet Vegeta</div></div>
      </div>

      <div class="table-container mt-20">
        <table>
          <thead><tr><th>Name</th><th>Race</th><th>Planet</th><th>Power Level</th><th>Status</th></tr></thead>
          <tbody id="worldviewTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- TIMELINE (restored from document 1) -->
    <section id="timeline" class="page">
      <div class="page-header">
        <h1 class="page-title">RP Timeline</h1>
        <p class="page-subtitle">The history and major events of your Dragon Ball RP universe</p>
        <button id="addEventBtn" class="btn btn-primary admin-only" onclick="showModal('edit-timeline-modal')"><i class="fas fa-plus"></i> Add Event</button>
      </div>

      <div class="timeline" id="timelineContainer"></div>
    </section>

    <!-- RELATIONSHIPS (restored from document 1) -->
    <section id="relationships" class="page">
      <div class="page-header">
        <h1 class="page-title">Character Relationships</h1>
        <p class="page-subtitle">Visualize the connections between characters in your RP universe</p>
        <button id="editRelationsBtn" class="btn btn-primary admin-only" onclick="showModal('edit-relations-modal')"><i class="fas fa-edit"></i> Edit Relationships</button>
      </div>

      <div class="relationship-editor admin-only">
        <h3>Add Relationship</h3>
        <div class="relation-form">
          <select id="relationChar1" class="form-select"><option value="">Select Character 1</option></select>
          <select id="relationType" class="form-select"><option value="Ally">Ally</option><option value="Rival">Rival</option><option value="Mentor">Mentor</option><option value="Student">Student</option><option value="Family">Family</option><option value="Friend">Friend</option><option value="Enemy">Enemy</option></select>
          <select id="relationChar2" class="form-select"><option value="">Select Character 2</option></select>
          <button class="btn btn-primary" onclick="addRelationship()">Add Relationship</button>
        </div>
      </div>

      <div class="tree-container">
        <div class="tree" id="relationshipTree"></div>
      </div>

      <div class="text-center mt-20">
        <button class="btn btn-primary" onclick="generateRelationshipMap()"><i class="fas fa-sitemap"></i> Generate Full Relationship Map</button>
      </div>
    </section>

    <!-- MANAGE OCS (admin-only) -->
    <section id="manage" class="page admin-only">
      <div class="page-header">
        <h1 class="page-title">OC Management</h1>
        <p class="page-subtitle">Approve, edit, or remove Original Characters from your RP server</p>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <button class="btn btn-danger" onclick="bulkDeleteSelected()"><i class="fas fa-trash"></i> Delete Selected</button>
        <button class="btn" onclick="showHistory()"><i class="fas fa-history"></i> View History</button>
      </div>

      <div class="table-container">
        <table>
          <thead><tr><th><input id="bulkSelectAll" type="checkbox" onchange="toggleBulkSelectAll(this)" /></th><th>Name</th><th>Creator</th><th>Power</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="manageOcTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Simple Modals -->
    <div id="generic-modal" class="modal"><div class="modal-content"><div class="modal-header"><div id="generic-modal-title"></div><button class="modal-close" onclick="hideModal('generic-modal')">&times;</button></div><div class="modal-body" id="generic-modal-body"></div></div></div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal"><div class="modal-content">
      <div class="modal-header"><div>Admin Login</div><button class="modal-close" onclick="hideModal('admin-login-modal')">&times;</button></div>
      <div class="modal-body">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="adminPassword" type="password" class="form-input" placeholder="Admin password (if configured)" />
          <button class="btn btn-primary" onclick="loginAsAdmin()">Log in</button>
        </div>
        <hr style="margin:10px 0" />
        <div>
          <button class="btn" onclick="loginWithDiscord()"><i class="fab fa-discord"></i> Login with Discord</button>
          <div style="font-size:0.85rem;color:var(--muted);margin-top:8px">(If you want Discord login, configure Client ID in Admin Settings)</div>
        </div>
      </div>
    </div></div>

    <!-- Admin Settings Modal -->
    <div id="admin-settings-modal" class="modal"><div class="modal-content">
      <div class="modal-header"><div>Admin Settings</div><button class="modal-close" onclick="hideModal('admin-settings-modal')">&times;</button></div>
      <div class="modal-body">
        <div style="display:grid;gap:8px">
          <label class="label">Password (optional)</label>
          <input id="adminSettingPassword" class="form-input" />
          <label class="label">Discord OAuth Client ID (for login)</label>
          <input id="discordClientId" class="form-input" placeholder="Discord Client ID" />
          <label class="label">Allowed admin Discord usernames (one per line, e.g. User#1234)</label>
          <textarea id="allowedAdmins" class="form-textarea" placeholder="Example: AdminGuy#0001&#10;OtherAdmin#9999" style="min-height:120px"></textarea>
          <label class="label">Discord webhook (optional)</label>
          <input id="discordWebhook" class="form-input" placeholder="https://discord.com/api/webhooks/..." />
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn" onclick="hideModal('admin-settings-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveAdminSettings()">Save</button>
          </div>
          <hr />
          <div style="font-size:0.9rem;color:var(--muted)">
            <strong>Assets & downloads</strong>
            <p>Below are the recommended SFX & planet image sources (open links, download to your `assets/` folder and update `ASSETS` in the script if you place the files locally).</p>
            <div id="assetLinksContainer" style="display:grid;gap:6px"></div>
          </div>
        </div>
      </div>
    </div></div>

    <!-- Reports Modal -->
    <div id="reports-modal" class="modal"><div class="modal-content">
      <div class="modal-header"><div>Server Reports</div><button class="modal-close" onclick="hideModal('reports-modal')">&times;</button></div>
      <div class="modal-body" id="reportsBody"></div>
    </div></div>

    <!-- History Modal -->
    <div id="history-modal" class="modal"><div class="modal-content">
      <div class="modal-header"><div>History</div><button class="modal-close" onclick="hideModal('history-modal')">&times;</button></div>
      <div class="modal-body" id="historyBody"></div>
    </div></div>

  </main>
</div>

<script>
/* ===========================
   Constants / storage keys
   =========================== */
const ADMIN_KEY = 'db_rp_admin_settings_v1';
const OC_KEY = 'db_rp_ocs_v1';
const HISTORY_KEY = 'db_rp_history_v1';
const DISCARD_NOTIF_KEY = 'db_rp_discard_notifs_v1';

// default sample structure for portraits by PL ranges
const PL_PORTRAITS = [
  { name: 'Rookie', min: 0, max: 999, color: '#9aa0ff', file: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"><rect width="100%" height="100%" rx="8" fill="%230e0e15"/></svg>' },
  { name: 'Martial Artist', min: 1000, max: 9999, color: '#9ae0a3', file: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"><rect width="100%" height="100%" rx="8" fill="%23070b12"/></svg>' },
  { name: 'Elite', min: 10000, max: 99999, color: '#ffd24d', file: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"><rect width="100%" height="100%" rx="8" fill="%23080b14"/></svg>' },
  { name: 'Super', min: 100000, max: 999999, color: '#ff8a00', file: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"><rect width="100%" height="100%" rx="8" fill="%230a0b11"/></svg>' },
  { name: 'Godly', min: 1000000, max: 999999999, color: '#b270ff', file: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"><rect width="100%" height="100%" rx="8" fill="%23010b12"/></svg>' },
  { name: 'Infinite', min: Number.POSITIVE_INFINITY, max: Number.POSITIVE_INFINITY, color: '#ff77ff', file: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"><rect width="100%" height="100%" rx="8" fill="%23000"/></svg>' }
];

// assets (these are external web sources; download into /assets and update these if you want local files)
const ASSETS = {
  sfx: [
    { name: 'Scouter remake (Freesound)', url: 'https://freesound.org/people/Pablobd/sounds/518004/' },
    { name: 'Power-up (Pixabay)', url: 'https://pixabay.com/sound-effects/search/power-up/' },
    { name: 'Whoosh (Mixkit)', url: 'https://mixkit.co/free-sound-effects/whoosh/' },
    { name: 'Notification / Ding (Mixkit)', url: 'https://mixkit.co/free-sound-effects/notification/' },
    { name: 'Scouter button (MyInstants)', url: 'https://www.myinstants.com/en/instant/scout-boink-59600/' }
  ],
  planets: [
    {name:'Sadala', url:'https://static.wikia.nocookie.net/dragonball/images/3/36/Planet_Sadala.png/revision/latest/scale-to-width-down/300?cb=20181125012120'},
    {name:'Yardrat', url:'https://static.wikia.nocookie.net/dragonball/images/0/0c/Yardrat.png/revision/latest/scale-to-width-down/300?cb=20181125012120'},
    {name:'King Kai', url:'https://static.wikia.nocookie.net/dragonball/images/6/6a/King_Kai%27s_Planet.png/revision/latest/scale-to-width-down/300?cb=20181125012120'},
    {name:'New Namek', url:'https://static.wikia.nocookie.net/dragonball/images/9/9e/New_Namek.png/revision/latest/scale-to-width-down/300?cb=20181125012120'},
    {name:'Planet Namek (fandom render)', url:'https://dragonball.fandom.com/wiki/Namek?action=render&image=Namek.png'},
    {name:'Earth (placeholder svg)', url:''},
    {name:'Planet Vegeta (placeholder svg)', url:''}
  ]
};

/* ===========================
   Local state
   =========================== */
let adminSettings = JSON.parse(localStorage.getItem(ADMIN_KEY) || '{}');
if(!adminSettings.allowedAdmins) adminSettings.allowedAdmins = [];
let sampleOCs = JSON.parse(localStorage.getItem(OC_KEY) || '[]');
let ocHistory = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
let adminMode = (localStorage.getItem('adminMode') === 'true');
let reviewImagesIndex = 0;
window._stagedImages = window._stagedImages || []; // images currently staged for this sheet

/* ===========================
   Init UI (bindings + basic rendering)
   =========================== */
document.addEventListener('DOMContentLoaded', () => {
  // nav buttons
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const page = btn.getAttribute('data-page');
      if(page) showPage(page);
    });
  });

  // admin login button binds
  document.getElementById('adminLoginBtn').onclick = () => showModal('admin-login-modal');

  // attach posterFiles change listener (multi-file upload)
  const posterFilesEl = document.getElementById('posterFiles');
  if(posterFilesEl){
    posterFilesEl.removeEventListener('change', handlePosterFilesChange);
    posterFilesEl.addEventListener('change', handlePosterFilesChange);
  }

  // populate assets in admin modal
  renderAssetLinks();

  reflectAdminMode();
  renderAll();
});

/* ===========================
   Utility: show/hide modal
   =========================== */
function showModal(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.add('active');
  el.style.display = 'flex';
}
function hideModal(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.remove('active');
  el.style.display = 'none';
}

/* ===========================
   Render helpers
   =========================== */
function renderAll(){
  renderDashboardTable();
  renderWorldViewTable();
  renderManageTable();
  renderTimeline();
  renderRelationshipTree();
  updateCounts();
  updateImageViewer();
}

/* ---------------------------
   Dashboard / Tables
   --------------------------- */
function updateCounts(){
  document.getElementById('totalOCs').textContent = sampleOCs.length;
  document.getElementById('approvedOCs').textContent = sampleOCs.filter(o => o.status === 'approved').length;
  document.getElementById('pendingOCs').textContent = sampleOCs.filter(o => o.status === 'pending').length;
  document.getElementById('currentArcs').textContent = 0;
  const pending = sampleOCs.filter(o => o.status === 'pending').length;
  document.getElementById('pendingSummary').textContent = `You have ${pending} OCs waiting for your approval.`;
}

function renderDashboardTable(){
  const t = document.getElementById('dashboardOcTableBody');
  if(!t) return;
  t.innerHTML = '';
  sampleOCs.forEach(oc => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(oc.name || '')}</td>
      <td class="race-${(oc.race||'other').toLowerCase()}">${escapeHtml(oc.race||'—')}</td>
      <td>${(oc.power || '—')}</td>
      <td>${oc.status ? `<span class="badge ${oc.status==='approved'?'badge-success':'badge-warning'}">${escapeHtml(oc.status)}</span>` : '—'}</td>
      <td>
        <button class="btn btn-sm" onclick="quickEditOC('${oc.id}')"><i class="fas fa-edit"></i></button>
        <button class="btn btn-sm btn-danger" onclick="removeOC('${oc.id}')"><i class="fas fa-trash"></i></button>
      </td>`;
    t.appendChild(tr);
  });
}

/* ---------------------------
   Worldview table
   --------------------------- */
function renderWorldViewTable(){
  const t = document.getElementById('worldviewTableBody');
  if(!t) return;
  t.innerHTML = '';
  sampleOCs.forEach(oc => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(oc.name||'')}</td><td class="race-${(oc.race||'other').toLowerCase()}">${escapeHtml(oc.race||'')}</td><td>${escapeHtml(oc.homeplanet||'')}</td><td>${(oc.power||'—')}</td><td>${oc.status||'—'}</td>`;
    t.appendChild(tr);
  });
}

/* ---------------------------
   Manage table (admin)
   --------------------------- */
function renderManageTable(){
  const tb = document.getElementById('manageOcTableBody');
  if(!tb) return;
  tb.innerHTML = '';
  sampleOCs.forEach(oc => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input class="bulk-checkbox" type="checkbox" data-id="${oc.id}" /></td>
      <td>${escapeHtml(oc.name||'')}</td>
      <td>${escapeHtml(oc.creator||'')}</td>
      <td>${oc.power||'—'}</td>
      <td>${oc.status||'—'}</td>
      <td>
        <button class="btn btn-sm" onclick="reviewOC('${oc.id}')"><i class="fas fa-eye"></i></button>
        <button class="btn btn-sm btn-success" onclick="approveOC('${oc.id}')"><i class="fas fa-check"></i></button>
        <button class="btn btn-sm btn-danger" onclick="removeOC('${oc.id}')"><i class="fas fa-trash"></i></button>
      </td>`;
    tb.appendChild(tr);
  });
}

/* ===========================
   OC CRUD + Save from sheet
   =========================== */
function saveOCFromSheet(){
  const oc = {
    id: 'oc_' + Date.now(),
    name: document.getElementById('ocName').value.trim(),
    alias: document.getElementById('ocAlias').value.trim(),
    creator: document.getElementById('creatorInput').value.trim(),
    race: document.getElementById('raceSelect').value,
    homeplanet: document.getElementById('homeplanet').value,
    power: parseInt(document.getElementById('powerInput').value) || 0,
    images: Array.isArray(window._stagedImages) ? window._stagedImages.slice() : [], // <- store images (dataURLs)
    status: adminMode ? 'approved' : 'pending',
    createdAt: new Date().toISOString()
  };

  sampleOCs.unshift(oc);
  persistOCs();
  ocHistory.unshift({ ts: new Date().toISOString(), action: adminMode ? 'created (approved)' : 'created (pending)', ocName: oc.name, by: oc.creator || localStorage.getItem('adminName') || 'Guest' });
  persistHistory();
  renderAll();
  showToast('OC saved.');
}

/* remove */
function removeOC(id){
  if(!confirm('Delete this OC?')) return;
  sampleOCs = sampleOCs.filter(o => o.id !== id);
  persistOCs();
  renderAll();
}

/* approve */
function approveOC(id){
  const oc = sampleOCs.find(o => o.id === id);
  if(!oc) return;
  oc.status = 'approved';
  persistOCs();
  ocHistory.unshift({ ts: new Date().toISOString(), action: 'approved', ocName: oc.name, by: localStorage.getItem('adminName') || 'Admin' });
  persistHistory();
  renderAll();
  showToast('OC approved');
}

/* review single OC */
function reviewOC(id){
  const oc = sampleOCs.find(o => o.id === id);
  if(!oc) return;
  // open a generic modal with OC info & images
  const body = document.getElementById('generic-modal-body');
  body.innerHTML = `<h3 style="margin-top:0">${escapeHtml(oc.name)} ${oc.alias?('- '+escapeHtml(oc.alias)) : ''}</h3>
    <div><strong>Creator:</strong> ${escapeHtml(oc.creator||'')}</div>
    <div><strong>Race:</strong> ${escapeHtml(oc.race||'')}</div>
    <div style="margin-top:8px"><strong>Power:</strong> ${oc.power||'—'}</div>
    <div id="reviewImages" style="margin-top:12px"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-success" onclick="approveOC('${oc.id}')">Approve</button>
      <button class="btn btn-danger" onclick="removeOC('${oc.id}')">Delete</button>
    </div>`;
  renderReviewImages(oc.images || []);
  showModal('generic-modal');
}

/* render images for review */
function renderReviewImages(images){
  const wrap=document.getElementById('reviewImages'); if(!wrap) return; wrap.innerHTML='';
  if(!images||!images.length){ wrap.innerHTML='<div style="color:var(--muted)">No images provided</div>'; return; }
  images.forEach((src, idx)=>{
    const img=document.createElement('img'); img.src=src; img.style.maxWidth='100%'; img.style.borderRadius='8px'; img.style.marginBottom='8px'; img.style.display='block';
    wrap.appendChild(img);
  });
}

/* ===========================
   Image uploader & carousel for OC Sheet
   Fixed: allow multiple images, preserve existing, navigation
   =========================== */
function handlePosterFilesChange(e){
  const files = Array.from(e.target.files || []);
  if(!files.length) return;
  const readers = files.map(f=>new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(f);
  }));
  Promise.all(readers).then(results=>{
    // append new images preserving existing ones
    window._stagedImages = (window._stagedImages || []).concat(results);
    // keep the review index in bounds
    if(typeof reviewImagesIndex !== 'number' || reviewImagesIndex < 0) reviewImagesIndex = 0;
    updateImageViewer();
    saveState();
  }).catch(()=>showToast('Failed to load images'));
}

function updateImageViewer(){
  const display = document.getElementById('ocImageDisplay');
  const count = document.getElementById('imageCount');
  if(!display) return;
  display.innerHTML = '';
  const imgs = window._stagedImages || [];
  if(!imgs.length){
    display.innerHTML = '<div class="oc-image-placeholder"><i class="fas fa-image" style="font-size:2rem;margin-bottom:8px"></i><div>Click to upload images</div></div>';
    if(count) count.textContent='';
    return;
  }
  if(typeof reviewImagesIndex !== 'number' || reviewImagesIndex >= imgs.length) reviewImagesIndex = 0;
  const img = document.createElement('img'); img.src = imgs[reviewImagesIndex % imgs.length]; img.style.maxWidth='100%'; img.style.maxHeight='160px'; img.style.objectFit='contain';
  display.appendChild(img);
  if(count) count.textContent = `${reviewImagesIndex+1} / ${imgs.length}`;
}

function prevImage(e){ if(e) e.stopPropagation(); const imgs = window._stagedImages || []; if(!imgs.length) return; reviewImagesIndex = (reviewImagesIndex - 1 + imgs.length) % imgs.length; updateImageViewer(); }
function nextImage(e){ if(e) e.stopPropagation(); const imgs = window._stagedImages || []; if(!imgs.length) return; reviewImagesIndex = (reviewImagesIndex + 1) % imgs.length; updateImageViewer(); }

/* on load, also render the staged images if oc being reviewed */
function renderReviewImagesFromOC(oc){
  reviewImagesIndex = 0;
  if(oc && oc.images && oc.images.length){
    // Fixed: set stagedImages to oc.images (was a buggy array spread before)
    window._stagedImages = (Array.isArray(oc.images) ? oc.images.slice() : []);
  } else {
    window._stagedImages = [];
  }
  updateImageViewer();
}

/* ===========================
   Section toggles
   =========================== */
function toggleSection(head){
  const section = head.parentElement;
  const isCollapsed = section.classList.toggle('collapsed');
  const meta = head.querySelector('.meta');
  if (meta) meta.textContent = isCollapsed ? '▲' : '▼';
}
function toggleAllSections(expand){
  document.querySelectorAll('.oc-section').forEach(s => {
    s.classList.toggle('collapsed', !expand);
    const meta = s.querySelector('.meta');
    if (meta) meta.textContent = expand ? '▼' : '▲';
  });
}

/* ===========================
   Persist helpers
   =========================== */
function persistOCs(){ localStorage.setItem(OC_KEY, JSON.stringify(sampleOCs)); updateCounts(); renderAll(); }
function persistHistory(){ localStorage.setItem(HISTORY_KEY, JSON.stringify(ocHistory)); }

/* ===========================
   Simple small helpers
   =========================== */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function nl2br(s){ if(!s) return ''; return escapeHtml(s).replace(/\n/g,'<br>'); }
function showToast(msg){ console.log('TOAST:', msg); /* small placeholder - you can add a toast UI here */ }

/* ===========================
   Fill example / clear
   =========================== */
function fillExample(){
  document.getElementById('ocName').value = 'Kairo';
  document.getElementById('ocAlias').value = 'Star Wanderer';
  document.getElementById('raceSelect').value = 'Saiyan';
  document.getElementById('powerInput').value = '120000';
  document.getElementById('creatorInput').value = '@Example#0001';
  saveState();
  updateImageViewer();
}
function clearAll(){
  if(!confirm('Clear the entire sheet?')) return;
  document.querySelectorAll('#oc-sheet input, #oc-sheet textarea').forEach(i=>i.value='');
  document.querySelectorAll('#oc-sheet [contenteditable]').forEach(d=>d.textContent = d.dataset.placeholder || '');
  ['abilitiesList','techniquesList','transformsList','equipmentList'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.innerHTML = '';
  });
  window._stagedImages = [];
  updateImageViewer();
  saveState();
}

/* ===========================
   Entry builder (abilities, transforms, etc)
   =========================== */
function addEntry(listId, kind = 'generic', data = {}){
  const list = document.getElementById(listId);
  if (!list) return;
  const entry = document.createElement('div');
  entry.className = 'entry';
  entry.draggable = true;
  entry.innerHTML = `
    <div class="entry-number"></div>
    <div class="entry-img-wrap" title="Click to change image">
      <img src="${data.image ? data.image : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0n84Jy...'}" />
    </div>
    <div class="entry-content">
      <input type="text" placeholder="Title" value="${data.title || ''}" />
      <textarea placeholder="Description">${data.desc || ''}</textarea>
    </div>
    <button class="remove-btn" title="Remove" onclick="this.closest('.entry').remove()">✕</button>
  `;
  // update number
  list.appendChild(entry);
  Array.from(list.querySelectorAll('.entry')).forEach((e, i) => {
    const n = e.querySelector('.entry-number'); if(n) n.textContent = (i+1);
  });
}

/* ===========================
   Power level reading
   - fixed portrait and aura updating
   - CAN fetch portrait using external file urls (see PL_PORTRAITS array)
   =========================== */
function getPLName(pl){
  for(const p of PL_PORTRAITS) if(pl>=p.min && pl<=p.max) return p.name;
  return '—';
}
function readPower(){
  const n = parseInt(document.getElementById('powerInput').value) || 0;
  document.getElementById('plValue').textContent = n ? n.toLocaleString() : '—';

  let cat = 'Unknown';
  if (n === 0) cat = 'No reading';
  else if (n < 1000) cat = 'Rookie Fighter';
  else if (n < 10000) cat = 'Martial Artist';
  else if (n < 100000) cat = 'Elite Warrior';
  else if (n < 1000000) cat = 'Super Warrior';
  else if (n < 10000000) cat = 'Planet Buster';
  else if (n < 1000000000) cat = 'Godly Being';
  else cat = 'Multiversal Entity';

  // Over 9000 easter egg
  if (n >= 9001 && n < 1000000000) {
      document.getElementById('plCategory').textContent = "IT'S OVER 9000!";
  } else {
      document.getElementById('plCategory').textContent = cat;
  }

  // Update portrait based on power level (PL_PORTRAITS)
  const match = PL_PORTRAITS.find(p => n >= p.min && n <= p.max) || PL_PORTRAITS[0];
  document.getElementById('plPortraitName').textContent = match.name;
  document.getElementById('plPortraitRange').textContent = `${(match.min === 0 ? '0' : (match.min || '—')).toString()} — ${(match.max === Number.POSITIVE_INFINITY) ? '∞' : (match.max || '—')}`;

  // Set image and aura
  document.getElementById('plPortraitImg').src = match.file;
  document.getElementById('plPortraitAura').style.backgroundColor = match.color;
  document.getElementById('plPortraitAura').style.boxShadow = `0 0 15px ${match.color}`;

  // Set border color
  document.getElementById('plPortraitWrap').style.borderColor = match.color;
}

/* ===========================
   Admin / settings / login
   - fixed login/logout flow
   - added Discord login (client-side OAuth)
   - allowedAdmins list auto-grants admin rights
   =========================== */
function showAdminSettings(){ 
  document.getElementById('adminSettingPassword').value = adminSettings.password || ''; 
  document.getElementById('discordClientId').value = adminSettings.discordClientId || '';
  document.getElementById('discordWebhook').value = adminSettings.webhook || ''; 
  document.getElementById('allowedAdmins').value = (adminSettings.allowedAdmins || []).join('\n');
  renderAssetLinks();
  showModal('admin-settings-modal'); 
}
function saveAdminSettings(){
  const pw = document.getElementById('adminSettingPassword')?.value;
  const cid = document.getElementById('discordClientId')?.value;
  const wh = document.getElementById('discordWebhook')?.value;
  const allowed = (document.getElementById('allowedAdmins')?.value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(pw) adminSettings.password = pw;
  adminSettings.discordClientId = cid || '';
  adminSettings.webhook = wh || '';
  adminSettings.allowedAdmins = allowed;
  localStorage.setItem(ADMIN_KEY, JSON.stringify(adminSettings));
  hideModal('admin-settings-modal'); showToast('Admin settings saved');
}

/* plain password login (legacy/demo) */
function loginAsAdmin(){
  const pw = document.getElementById('adminPassword')?.value || '';
  const real = adminSettings.password || 'admin'; // default password if not set
  if(pw === real){
    adminMode = true; localStorage.setItem('adminMode','true'); localStorage.setItem('adminName','Staff'); document.getElementById('adminBadge').style.display='inline-block'; document.querySelectorAll('.admin-only').forEach(el=>el.style.display='block'); hideModal('admin-login-modal'); showToast('Admin mode enabled'); renderAll();
  } else { alert('Incorrect password'); }
}

/* Discord login flow (client-side token flow) */
function loginWithDiscord(){
  // must have configured client id
  const clientId = adminSettings.discordClientId || document.getElementById('discordClientId')?.value;
  if(!clientId){
    alert('Please set the Discord Client ID in Admin Settings first.');
    showAdminSettings();
    return;
  }
  // scopes: identify to fetch username & discriminator
  const redirect = window.location.href.split('#')[0];
  const url = `https://discord.com/api/oauth2/authorize?client_id=${encodeURIComponent(clientId)}&redirect_uri=${encodeURIComponent(redirect)}&response_type=token&scope=identify`;
  // open OAuth window (redirects back to this page with access_token in hash)
  window.location.href = url;
}

/* parse token (if returned from discord implicit flow) */
(function parseDiscordTokenOnLoad(){
  const hash = window.location.hash || '';
  if(hash.includes('access_token=')){
    const params = new URLSearchParams(hash.replace('#',''));
    const accessToken = params.get('access_token');
    // store token locally (ephemeral)
    if(accessToken){
      localStorage.setItem('discord_access_token', accessToken);
      // remove token fragment from URL
      history.replaceState(null, '', window.location.pathname + window.location.search);
      // fetch user
      fetchDiscordUser(accessToken).then(user=>{
        if(!user) return;
        const username = `${user.username}#${user.discriminator}`;
        localStorage.setItem('adminName', username);
        // if username is in allowedAdmins, grant admin
        const allowed = adminSettings.allowedAdmins || [];
        if(allowed.includes(username)){
          adminMode = true;
          localStorage.setItem('adminMode','true');
          showToast('Discord account accepted: admin mode enabled');
        } else {
          // Not in allowed list, ask to add?
          if(confirm(`${username} is not in the allowed admin list. Add as admin?`)){
            adminSettings.allowedAdmins = Array.from(new Set([...(adminSettings.allowedAdmins || []), username]));
            localStorage.setItem(ADMIN_KEY, JSON.stringify(adminSettings));
            adminMode = true;
            localStorage.setItem('adminMode','true');
            showToast('Added to allowed admins and enabled admin mode.');
          } else {
            showToast('Discord account recognized but not added to admin list.');
          }
        }
        reflectAdminMode();
        renderAll();
      });
    }
  }
})();

async function fetchDiscordUser(token){
  try{
    const res = await fetch('https://discord.com/api/users/@me', { headers: { Authorization: `Bearer ${token}` }});
    if(!res.ok) { console.warn('Discord API error', res.status); return null; }
    const j = await res.json(); return j;
  }catch(e){ console.warn('Discord fetch failed', e); return null; }
}

/* logout */
function disableAdminMode(){
  adminMode = false;
  localStorage.setItem('adminMode','false');
  localStorage.removeItem('adminName');
  document.getElementById('adminBadge').style.display = 'none';
  document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
  // remove saved discord token
  localStorage.removeItem('discord_access_token');
  // revert admin login button
  document.getElementById('adminLoginBtn').innerHTML = '<i class="fas fa-lock"></i> Admin Login';
  document.getElementById('adminLoginBtn').onclick = () => showModal('admin-login-modal');
  showToast('Logged out of admin mode');
}

/* reflect admin on load */
function reflectAdminMode(){
  if(localStorage.getItem('adminMode') === 'true'){ adminMode = true; document.getElementById('adminBadge').style.display='inline-block'; document.querySelectorAll('.admin-only').forEach(el=>el.style.display='block'); document.getElementById('adminLoginBtn').innerHTML = '<i class="fas fa-unlock"></i> Admin Logout'; document.getElementById('adminLoginBtn').onclick = disableAdminMode; }
  else { adminMode = false; document.getElementById('adminBadge').style.display='none'; document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none'); document.getElementById('adminLoginBtn').innerHTML = '<i class="fas fa-lock"></i> Admin Login'; document.getElementById('adminLoginBtn').onclick = () => showModal('admin-login-modal'); }
}

/* ===========================
   Timeline & Relationships (restored)
   (basic client storage + UI)
   =========================== */
let timelineEvents = JSON.parse(localStorage.getItem('db_rp_timeline') || '[]');
function renderTimeline(){
  const cont = document.getElementById('timelineContainer');
  if(!cont) return;
  cont.innerHTML = '';
  if(!timelineEvents.length){
    cont.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No events added</div>';
    return;
  }
  timelineEvents.forEach((ev, idx) => {
    const itm = document.createElement('div');
    itm.className = 'timeline-item';
    itm.style.width = '100%';
    itm.innerHTML = `<div class="timeline-content"><div class="timeline-date">${escapeHtml(ev.date || '')}</div><div class="timeline-title">${escapeHtml(ev.title||'')}</div><div class="timeline-desc">${nl2br(ev.desc||'')}</div></div>`;
    cont.appendChild(itm);
  });
}

let relationships = JSON.parse(localStorage.getItem('db_rp_rels') || '[]');
function addRelationship(){
  const c1 = document.getElementById('relationChar1').value;
  const c2 = document.getElementById('relationChar2').value;
  const type = document.getElementById('relationType').value;
  if(!c1 || !c2) { alert('Select two characters'); return; }
  relationships.push({ a: c1, b: c2, t: type });
  localStorage.setItem('db_rp_rels', JSON.stringify(relationships));
  renderRelationshipTree();
}

function renderRelationshipTree(){
  const tree = document.getElementById('relationshipTree');
  if(!tree) return;
  tree.innerHTML = '';
  // simple render: group by first char
  const byName = {};
  sampleOCs.forEach(o => byName[o.name] = o);
  relationships.forEach(r => {
    const node = document.createElement('div');
    node.className = 'tree-node';
    node.innerHTML = `<div>${escapeHtml(r.a)} → ${escapeHtml(r.b)}</div><div class="tree-relation">${escapeHtml(r.t)}</div>`;
    tree.appendChild(node);
  });
}

/* ---------------------------
   Generate relationships map (simple)
   --------------------------- */
function generateRelationshipMap(){
  // this is a simple client-side generation for now
  alert('Generating relationship map — simple client-side preview. Expand later with graph rendering.');
  renderRelationshipTree();
}

/* ===========================
   Reports (View Reports)
   =========================== */
function openReports(){
  const body = document.getElementById('reportsBody');
  const total = sampleOCs.length;
  const approved = sampleOCs.filter(o=>o.status==='approved').length;
  const pending = sampleOCs.filter(o=>o.status==='pending').length;
  const top = sampleOCs.slice().sort((a,b)=> (b.power||0)-(a.power||0)).slice(0,6);
  body.innerHTML = `<div style="display:grid;gap:10px">
    <div><strong>Total OCs:</strong> ${total}</div>
    <div><strong>Approved:</strong> ${approved}</div>
    <div><strong>Pending:</strong> ${pending}</div>
    <div><strong>Top Power Levels:</strong><ol>${top.map(t=>`<li>${escapeHtml(t.name)} — ${(t.power||'—')}</li>`).join('')}</ol></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="downloadReportsCSV()">Download CSV</button>
      <button class="btn btn-primary" onclick="hideModal('reports-modal')">Close</button>
    </div>
  </div>`;
  showModal('reports-modal');
}

function downloadReportsCSV(){
  const rows = [['name','creator','race','power','status','createdAt']];
  sampleOCs.forEach(o => rows.push([o.name||'', o.creator||'', o.race||'', o.power||'', o.status||'', o.createdAt||'']));
  const csv = rows.map(r => r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'db_rp_reports.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ===========================
   Helpers: persistence & misc
   =========================== */
function persistAdminSettings(){ localStorage.setItem(ADMIN_KEY, JSON.stringify(adminSettings)); }
function saveState(){ /* placeholder to save sheet state locally if desired */ }

/* ===========================
   Bulk delete + selection
   =========================== */
function toggleBulkSelectAll(el){
  const checked = el.checked;
  document.querySelectorAll('.bulk-checkbox').forEach(cb => cb.checked = checked);
}
function bulkDeleteSelected(){
  if(!confirm('Delete selected OCs?')) return;
  const ids = Array.from(document.querySelectorAll('.bulk-checkbox:checked')).map(cb => cb.dataset.id);
  sampleOCs = sampleOCs.filter(o => !ids.includes(o.id));
  persistOCs();
  renderAll();
}

/* ===========================
   Small storage helpers
   =========================== */
function persistOCs(){ localStorage.setItem(OC_KEY, JSON.stringify(sampleOCs)); updateCounts(); renderAll(); }
function persistHistory(){ localStorage.setItem(HISTORY_KEY, JSON.stringify(ocHistory)); }

/* ===========================
   Utility: asset links in admin modal
   =========================== */
function renderAssetLinks(){
  const c = document.getElementById('assetLinksContainer');
  if(!c) return;
  c.innerHTML = '';
  const sfxHead = document.createElement('div'); sfxHead.style.fontWeight = 800; sfxHead.textContent = 'Sound FX:';
  c.appendChild(sfxHead);
  ASSETS.sfx.forEach(s => {
    const d = document.createElement('div'); d.innerHTML = `<a href="${s.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(s.name)}</a> — open to download`; c.appendChild(d);
  });
  const pHead = document.createElement('div'); pHead.style.fontWeight = 800; pHead.style.marginTop='8px'; pHead.textContent = 'Planet images:';
  c.appendChild(pHead);
  ASSETS.planets.forEach(p => {
    const d = document.createElement('div'); d.innerHTML = p.url ? `<a href="${p.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(p.name)}</a>` : `<span>${escapeHtml(p.name)} — (placeholder)</span>`; c.appendChild(d);
  });
}

/* ===========================
   Small helpers used earlier
   (some duplicates consolidated)
   =========================== */
function showHistory(){
  const body = document.getElementById('historyBody'); body.innerHTML = '';
  ocHistory.slice(0,200).forEach(h=>{
    const div = document.createElement('div'); div.style.borderBottom='1px solid rgba(255,255,255,0.03)'; div.style.padding='8px 0';
    div.innerHTML = `<div style="font-weight:700">${escapeHtml(h.action||'')}</div><div style="color:var(--muted);font-size:0.85rem">${escapeHtml(h.ocName||'')} • ${escapeHtml(h.by||'')}</div><div style="color:var(--muted);font-size:0.75rem">${new Date(h.ts).toLocaleString()}</div>`;
    body.appendChild(div);
  });
  showModal('history-modal');
}

/* ===========================
   Small UI helpers
   =========================== */
function showToast(msg){ console.log('TH:', msg); /* keep minimal to avoid UI changes */ }

/* ===========================
   Startup: render persisted content
   =========================== */
(function startupRender(){
  // load persisted state (already loaded into sampleOCs/ocHistory)
  reflectAdminMode();
  renderAll();
})();

</script>
</body>
</html>
